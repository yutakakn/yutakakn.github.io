/* 2001/1/28 - 1/30
 *
 * puz0102.c    with gcc 2.95.2(TurboLinux Workstation 6.0)
 * CMAGAZINE 2001/2 No.119[IIIŒ^‘f‘g”]
 *
 * Copyright (C)1996-2001 •½“c–L
 * All rights reserved.
 */
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <time.h>

#define N 3            /* Œ^” */
#define KETA_MAX 100   /* ‘f‘g”‚ÌÅ‘åŒ…” */

/* N Œ…‚Ì‘f”ƒe[ƒuƒ‹ */
int primes[200];
int prime_cnt;
int use[200];

int numbuf[KETA_MAX];  /* ‘f‘g” */

int max_keta = 3;      /* ‹‚ß‚éÅ‘åŒ…” */

/* ‰ğ */
int ansbuf[10000][KETA_MAX];
int anscnt = 0;


/* ‘f”‚ğ1Œ…‚²‚Æ‚É•ªŠ„‚·‚é */
#if 1

#define split_prime(prime, num) { \
	num[0] = prime / 100; \
	num[1] = (prime / 10) % 10; \
	num[2] = prime % 10; \
}

#define split2_prime(prime, num) { \
	num[0] = prime / 10; \
	num[1] = prime % 10; \
}

#else

void split_prime(int prime, int *num)
{
#if 0
	/* ”Ä—p«‚ğ‚½‚¹‚é‚È‚ç‚±‚¿‚ç‚ğg‚¤(Œƒ’x^^;) */
	static char buf[N + 1];
	int i;

	sprintf(buf, "%d", prime);
	for (i = 0 ; i < N ; i++) {
		num[i] = buf[i] - '0';
	}
#else
	#if (N == 2)
		num[0] = prime / 10;
		num[1] = prime % 10;
	#else
		num[0] = prime / 100;
		num[1] = (prime / 10) % 10;
		num[2] = prime % 10;
	#endif
#endif
}

#endif


/* ‰ğ‚Ì‹L˜^ */
void record(int pi)
{
	int i;

	for (i = 0 ; i < pi ; i++) {
		ansbuf[anscnt][i] = numbuf[i];
	}
	anscnt++;
}

/* ‘f‘g”‚ğ¶¬‚·‚éB
 *
 *       „¬„ª„±„ª„±„ª„±„ª„±„ª„­
 * numbuf„«6 „«1 „«9 „«  „«  „«
 *       „¯„ª„³„ª„³„ª„³„ª„³„ª„®
 *             ci      pi     -->
 */
void sub(int ci, int pi)
{
	int num[N], pnum[N];
	int i, j;

	/* Å‘åŒ…‚ÌXV */
	if (pi > max_keta) {
		max_keta = pi;
		anscnt = 0;
		record(pi);

		return;
	}

	/* “¯‚¶Œ…‚Í‹L˜^‚·‚é‚Ì‚İ */
	if (pi == max_keta) {
		record(pi);
	}


	/* ƒoƒbƒtƒ@‚Ì ci ` pi ‚Ü‚Å‚ğæ‚èo‚·B*/
	for (i = 0 ; i < N - 1 ; i++) {
		num[i] = numbuf[ci + i];
	}

	/* Ÿ‚É•À‚×‚é‘f”‚ğæ‚èo‚· */
	for (i = 0 ; i < prime_cnt ; i++) {
		if (use[i])
			continue;

		split_prime(primes[i], pnum);

		for (j = 0 ; j < N-1 ; j++) {
			if (num[j] != pnum[j])
				break;
		}
		if (j != N-1) {
			continue;
		}
		/* æ‚èo‚µ‚½‘f”‚Ì•û‚ª‘å‚«‚¢‚È‚çAˆÈ~‚Ì‘f”‚ğ
		 * ‚·‚Ì‚Í–³‘Ê(‘f”ƒe[ƒuƒ‹‚Í¸‡‚É•À‚ñ‚Å‚¢‚é‚½‚ß)B
		 */
		if (pnum[0] > num[0])
			break;

		use[i] = 1;
		numbuf[pi] = pnum[N-1];

		sub(ci + 1, pi + 1);

		numbuf[pi] = 0;
		use[i] = 0;
	}
}


/* —^‚¦‚ç‚ê‚½”’l‚ª‘f”‚©‚Ç‚¤‚©”»•Ê */
int is_prime(int n)
{
	int i;

	if (n % 2 == 0)
		return 0;

	for (i = 3 ; ; i += 2) {
		if (i * i > n)
			break;
		if (n % i == 0)
			return 0;
	}
	return 1;
}

/* N Œ…‚Ì‘f”‚ğ¶¬‚·‚é */
void make_prime(void)
{
	int i, min, max;

	min = 1;
	for (i = 0 ; i < N - 1 ; i++) {
		min *= 10;
	}
	max = 10 * min - 1;

	prime_cnt = 0;
	for (i = min ; i <= max ; i++) {
		if (is_prime(i)) {
			primes[prime_cnt] = i;
			prime_cnt++;
		}
	}

#if 0
	for (i = 0 ; i < prime_cnt ; i++) {
		printf("%d ", primes[i]);
	}
	printf("\n%d counts\n", prime_cnt);
	exit(1);
#endif
}

int main(void)
{
	clock_t t = clock();
	int i, n, p;

	/* ‘f”‚Í‚ ‚ç‚©‚¶‚ß‹‚ß‚Ä‚¨‚­ */
	make_prime();

	/* ‘f‘g”‚Í¶’[‚©‚çŒˆ’è‚µ‚Ä‚¢‚­ */
	for (n = 0 ; n < prime_cnt ; n++) {
		p = primes[n];
		split_prime(p, numbuf);

		use[n] = 1;

		sub(1, N);

		use[n] = 0;
	}

	/* ‰ğ‚Ì•\¦ */
	for (i = 0 ; i < anscnt ; i++) {
		printf("No.%d: ", i+1);
		for (n = 0 ; n < max_keta ; n++) {
			printf("%d", ansbuf[i][n]);
		}
		if (i == anscnt - 1) {
			printf("  Å‘å’l");
		}
		printf("\n");
	}
	printf("%d Œ^‘f‘g”\n", N);
	printf("Å‘åŒ… %d  ŒÂ” %d\n", max_keta, anscnt);

    printf("time %.2f\n", (double)((clock() - t) / CLOCKS_PER_SEC));
	return 0;
}

